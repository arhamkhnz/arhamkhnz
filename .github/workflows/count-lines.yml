name: Update Lines of Code in README

on:
  schedule:
    - cron: "0 0 * * 0" # Runs weekly
  workflow_dispatch: # Allows manual trigger

jobs:
  count-lines:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq cloc

    - name: Fetch and Clone Repositories
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
      run: |
        USERNAME="arhamkhnz"
        REPOS=$(curl -H "Authorization: token $GH_PAT" -s "https://api.github.com/user/repos?per_page=100" \
          | jq -r 'map(select(.fork == false)) | .[].clone_url')

        mkdir -p public-repos
        cd public-repos

        TOTAL_LINES=0

        for REPO in $REPOS; do
          # Replace the URL to include the token for authentication
          AUTHENTICATED_REPO=$(echo "$REPO" | sed "s/https:\/\//https:\/\/$GH_PAT@/g")
          REPO_NAME=$(basename "$REPO" .git)

          echo "Cloning $REPO_NAME..."
          git clone --mirror "$AUTHENTICATED_REPO" "$REPO_NAME.git" > /dev/null 2>&1

          # Navigate into the repository and fetch all branches
          cd "$REPO_NAME.git" || exit
          git remote update > /dev/null 2>&1

          # Process each branch and calculate lines of code
          for BRANCH in $(git branch -r | grep -v '\->' | sed 's/origin\///'); do
            echo "Processing branch: $BRANCH"
            git checkout "$BRANCH" > /dev/null 2>&1
            BRANCH_LINES=$(cloc . --json | jq '.SUM.code // 0')
            TOTAL_LINES=$((TOTAL_LINES + BRANCH_LINES))
          done
          cd ..
          rm -rf "$REPO_NAME.git" # Clean up the repository
        done

        # Store the total lines of code in a file
        mkdir -p ../output
        echo $TOTAL_LINES > ../output/total-lines.txt

    - name: Update README.md
      run: |
        # Read the total lines of code
        TOTAL_LINES=$(cat output/total-lines.txt)

        # Replace the placeholder in README.md
        sed -i "/<!-- lines-of-code -->/c\Total Lines of Code: $TOTAL_LINES <!-- lines-of-code -->" README.md

    - name: Stage All Changes
      run: |
        git add README.md # Stage the updated README.md

    - name: Commit and Push Changes
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git commit -m "Update total lines of code" || echo "No changes to commit"
        git push