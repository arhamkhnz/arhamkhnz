name: Update Lines of Code in README

on:
  schedule:
    - cron: "0 0 * * 0" # Runs weekly
  workflow_dispatch: # Allows manual trigger

jobs:
  count-lines:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq cloc

    - name: Fetch and Clone Repositories
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
      run: |
        USERNAME="arhamkhnz"
        REPOS=$(curl -H "Authorization: token $GH_PAT" -s "https://api.github.com/user/repos?per_page=100" \
          | jq -r 'map(select(.fork == false)) | .[].clone_url')

        mkdir -p public-repos
        cd public-repos
        
        for REPO in $REPOS; do
          # Replace the URL to include the token for authentication
          AUTHENTICATED_REPO=$(echo "$REPO" | sed "s/https:\/\//https:\/\/$GH_PAT@/g")
          echo "Cloning $AUTHENTICATED_REPO..."
          git clone "$AUTHENTICATED_REPO"
        done

        echo "Calculating total lines of code..."
        mkdir -p ../output
        cloc . --json > ../output/cloc-output.json

    - name: Update README.md
      run: |
        # Extract the total lines of code from cloc-output.json
        TOTAL_LINES=$(jq '.SUM.code' output/cloc-output.json)
        
        # Replace the placeholder in README.md
        sed -i "/<!-- lines-of-code -->/c\Total Lines of Code: $TOTAL_LINES <!-- lines-of-code -->" README.md

    - name: Stage All Changes
      run: |
        git add README.md output/cloc-output.json # Stages updated files

    - name: Commit and Push Changes
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git commit -m "Update total lines of code" || echo "No changes to commit"
        git push